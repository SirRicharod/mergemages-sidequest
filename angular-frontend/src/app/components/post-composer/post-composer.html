@if (popupVisible) {
<div class="popup-backdrop"></div>
<div class="popup" role="dialog" aria-modal="true">
  <div class="popup-card">
    <div class="popup-header d-flex justify-content-between align-items-center">
      <strong>Create a post</strong>
      <div class="d-flex align-items-center gap-3">
        @if (auth.currentUser()) {
          <span class="badge bg-primary">XP: {{ auth.currentUser()?.xp_balance }}</span>
        }
        <button class="btn-close" aria-label="Close" (click)="togglePopup()"></button>
      </div>
    </div>

    <div class="popup-body">
      @if (validationError) {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          {{ validationError }}
          <button type="button" class="btn-close" aria-label="Close" (click)="validationError = ''"></button>
        </div>
      }
      <form (submit)="$event.preventDefault(); onSubmit()">
        <!-- Title -->
        <div class="mb-3">
          <label class="form-label" for="postTitle">Title</label>
          <input id="postTitle" type="text" class="form-control" [(ngModel)]="title" name="title" 
            maxlength="200" required>
          <div class="text-muted small mt-1 text-end">{{ title.length }}/200</div>
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label class="form-label" for="postDescription">Description</label>
          <textarea id="postDescription" rows="4" class="form-control" [(ngModel)]="description" name="description"
            maxlength="2000" required></textarea>
          <div class="text-muted small mt-1 text-end">{{ description.length }}/2000</div>
        </div>

        <!-- Type -->
        <div class="mb-3">
          <label class="form-label d-block">Type</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" id="typeRequest" name="type" [(ngModel)]="type"
              value="request">
            <label class="form-check-label" for="typeRequest">I'm looking for</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" id="typeOffer" name="type" [(ngModel)]="type" value="offer">
            <label class="form-check-label" for="typeOffer">I can do</label>
          </div>
        </div>

        <!-- Deadline + Boost + XP Reward -->
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-4">
            <label class="form-label" for="postDeadline">Deadline</label>
            <input id="postDeadline" type="date" class="form-control" [(ngModel)]="deadline" name="deadline" required>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label" for="xpReward">XP Reward (100-500)</label>
            <input id="xpReward" type="number" class="form-control" [(ngModel)]="xpReward" name="xpReward"
              min="100" max="500" step="10" required
              [class.is-invalid]="hasInsufficientXp">
            @if (hasInsufficientXp) {
              <div class="text-danger small mt-1">
                <i class="bi bi-exclamation-circle"></i> Need {{ xpShortfall }} more XP
              </div>
            }
          </div>
          <div class="col-12 col-md-4 d-flex align-items-end">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="boostPost" [(ngModel)]="boost" name="boost">
              <label class="form-check-label" for="boostPost">
                Boost post (+{{ BOOST_COST }} XP)
                @if (boost) {
                  <div class="text-muted small mt-1">
                    <i class="bi bi-lightning-charge-fill"></i> Total: {{ totalCost }} XP
                  </div>
                }
              </label>
            </div>
          </div>
        </div>

        <div class="mt-3 d-flex justify-content-end">
          <button class="btn btn-secondary me-2" type="button" (click)="togglePopup()">Cancel</button>
          <button class="btn btn-primary" type="submit" [disabled]="hasInsufficientXp">
            @if (hasInsufficientXp) {
              Insufficient XP
            } @else {
              Post
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
}